#!/bin/bash

# Step 1: Update the system and install all core dependencies
echo "Updating system and installing all required packages..."
sudo pacman -Syu --noconfirm
sudo pacman -S --noconfirm --needed \
    base-devel \
    gcc \
    meson \
    river \
    wlroots \
    wayland \
    wayland-protocols \
    libseat \
    libdrm \
    pango \
    gtk-layer-shell \
    cairo \
    jsoncpp \
    sddm \
    kitty \
    rofi \
    waybar \
    networkmanager \
    feh \
    ttf-dejavu \
    ttf-liberation \
    ttf-droid \
    noto-fonts \
    noto-fonts-emoji \
    lxqt \
    pcmanfm-qt \
    qt5ct \
    kvantum \
    kvantum-theme-materia \
    qogir-icon-theme \
    pulseaudio \
    pulseaudio-alsa \
    pavucontrol \
    pamixer \
    xorg-xwayland

# Step 2: Install SDDM Candy theme from the AUR
echo "Installing SDDM Candy theme from the AUR..."
yay -S --noconfirm sddm-candy-theme-git

# Step 3: Enable and start NetworkManager
echo "Enabling and starting NetworkManager..."
sudo systemctl enable NetworkManager.service
sudo systemctl start NetworkManager.service

# Step 4: Set up SDDM with the Candy theme and custom gradient background
echo "Configuring SDDM with the Candy theme and custom gradient background..."
sudo mkdir -p /etc/sddm.conf.d /usr/share/sddm/themes/candy/custom_backgrounds

# Set SDDM to use the Candy theme
sudo tee /etc/sddm.conf.d/theme.conf > /dev/null <<EOF
[Theme]
Current=candy
EOF

# Create custom gradient background for SDDM theme
sudo tee /usr/share/sddm/themes/candy/custom_backgrounds/gradient.svg > /dev/null <<EOF
<svg width="1920" height="1080" xmlns="http://www.w3.org/2000/svg">
  <defs>
    <linearGradient id="grad1" x1="100%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" style="stop-color:yellow;stop-opacity:1" />
      <stop offset="100%" style="stop-color:purple;stop-opacity:1" />
    </linearGradient>
  </defs>
  <rect width="100%" height="100%" fill="url(#grad1)" />
  <text x="50%" y="60%" font-family="monospace" font-size="80" fill="black" text-anchor="middle">Stickman-OS</text>
</svg>
EOF

# Update SDDM theme configuration to use custom background
sudo sed -i 's|background=.*|background=/usr/share/sddm/themes/candy/custom_backgrounds/gradient.svg|' /usr/share/sddm/themes/candy/theme.conf.user

# Enable SDDM to start on boot
sudo systemctl enable sddm.service
sudo systemctl start sddm.service

# Step 5: Create a custom session file for River in SDDM
echo "Setting up River as a session in SDDM..."
sudo tee /usr/share/wayland-sessions/river.desktop > /dev/null <<EOF
[Desktop Entry]
Name=River
Comment=River Window Manager
Exec=/usr/bin/river
Type=Application
DesktopNames=river
EOF

# Step 6: Configure Waybar with Stickman icon, modern, fully rounded theme, and floating bar
echo "Setting up Waybar configuration..."
mkdir -p ~/.config/waybar ~/.config/waybar/icons

# Generate a simple SVG stickman icon for Waybar
tee ~/.config/waybar/icons/stickman.svg > /dev/null <<EOF
<svg width="24" height="24" xmlns="http://www.w3.org/2000/svg">
  <circle cx="12" cy="5" r="3" fill="black" />
  <line x1="12" y1="8" x2="12" y2="16" stroke="black" stroke-width="2" />
  <line x1="12" y1="10" x2="9" y2="13" stroke="black" stroke-width="2" />
  <line x1="12" y1="10" x2="15" y2="13" stroke="black" stroke-width="2" />
  <line x1="12" y1="16" x2="10" y2="20" stroke="black" stroke-width="2" />
  <line x1="12" y1="16" x2="14" y2="20" stroke="black" stroke-width="2" />
</svg>
EOF

# Waybar configuration file without the battery module
tee ~/.config/waybar/config.json > /dev/null <<EOF
{
    "layer": "top",
    "position": "top",
    "height": 35,
    "margin": 10,
    "modules-left": ["custom/stickman", "workspaces"],
    "modules-center": ["clock"],
    "modules-right": ["custom/notifications", "cpu", "memory", "network", "custom/volume", "custom/microphone", "custom/power"],

    "custom/stickman": {
        "exec": "echo ' '",
        "return-type": "json",
        "tooltip": "Applications",
        "click": "rofi -show drun",
        "icon": "~/.config/waybar/icons/stickman.svg"
    },
    
    "workspaces": {
        "format": "{icon}",
        "icon-map": {
            "1": "", "2": "", "3": "", "4": "",
            "5": "", "6": "", "7": "", "8": "", "9": ""
        },
        "on-click": "riverctl switch-to-workspace {name}",
        "underline": true,
        "max-icons": 9
    },

    "clock": {
        "format": "{:%A, %B %d - %H:%M}",
        "interval": 60
    },

    "custom/notifications": {
        "exec": "notify-send 'No new notifications'",
        "return-type": "json",
        "click": "notify-send 'Checking notifications...'",
        "tooltip": "Notifications"
    },

    "cpu": {
        "format": "CPU: {usage}%",
        "tooltip-format": "CPU: {usage}%"
    },

    "memory": {
        "format": "RAM: {usedMem} MB",
        "tooltip-format": "Memory Used: {usedMem} MB"
    },

    "network": {
        "format": "{ifname} {ipaddr}",
        "tooltip-format": "Connected to {ifname} with IP {ipaddr}"
    },

    "custom/volume": {
        "exec": "pamixer --get-volume-human",
        "interval": 2,
        "return-type": "json",
        "icon": "audio-volume-high-symbolic",
        "tooltip": "Volume"
    },

    "custom/microphone": {
        "exec": "pamixer --default-source --get-volume-human",
        "interval": 2,
        "return-type": "json",
        "icon": "microphone-sensitivity-high-symbolic",
        "tooltip": "Microphone"
    },

    "custom/power": {
        "exec": "echo ''",
        "return-type": "json",
        "tooltip": "Power Options",
        "click": "rofi -show power-menu -modi power-menu:rofi-power-menu"
    },

    "style": {
        "bar": {
            "background": "#1E1E2EAA",
            "border-radius": 20,
            "padding": 8,
            "margin": 20
        },
        "separator": {
            "background": "#1E1E2EAA"
        }
    }
}
EOF

# Waybar CSS styling with rounded corners, floating bar, and monospace font
tee ~/.config/waybar/style.css > /dev/null <<EOF
* {
    color: #E1E1E1;
    font-family: "monospace";
    border-radius: 20px;
}

#workspaces, #custom-volume, #custom-microphone, #custom-power {
    border-radius: 20px;
}

#clock {
    font-size: 18px;
    font-weight: bold;
    color: #A3BE8C;
    padding: 8px;
}

#cpu, #memory, #network {
    font-size: 14px;
    padding: 8px;
    color: #B48EAD;
    border-radius: 20px;
}

#bar {
    background-color: #1E1E2EAA;
    border-radius: 20px;
    padding: 8px;
    margin: 20px;
}
EOF

# Step 7: Configure River keybindings
echo "Configuring keybindings in River..."
mkdir -p ~/.config/river
tee ~/.config/river/init > /dev/null <<EOF
# Keybindings for River

# Open Kitty terminal with Control+Enter
riverctl map normal Ctrl+Return spawn kitty

# Open Rofi with Control+D
riverctl map normal Ctrl+D spawn "rofi -show drun"

# Close a window with Control+Q
riverctl map normal Ctrl+Q close

# Kill a window with Control+Shift+Q
riverctl map normal Ctrl+Shift+Q kill

# Move focused window with Control+Arrow Keys
riverctl map normal Ctrl+Left send-to-output left
riverctl map normal Ctrl+Right send-to-output right
riverctl map normal Ctrl+Up send-to-workspace previous
riverctl map normal Ctrl+Down send-to-workspace next

# Return to SDDM with Control+Alt+Delete
riverctl map normal Ctrl+Alt+Delete spawn 'loginctl terminate-session $XDG_SESSION_ID'
EOF

# Step 8: Configure Monospace Font and Materia Dark Blue as the Default Qt Theme
echo "Configuring Monospace font and Materia Dark Blue theme as the default system theme..."

# GTK font settings
mkdir -p ~/.config/gtk-3.0
echo '[Settings]' > ~/.config/gtk-3.0/settings.ini
echo 'gtk-font-name=Monospace 11' >> ~/.config/gtk-3.0/settings.ini

# Qt5ct and Kvantum theme and font settings
mkdir -p ~/.config/qt5ct
echo '[Appearance]' > ~/.config/qt5ct/qt5ct.conf
echo 'style=kvantum' >> ~/.config/qt5ct/qt5ct.conf
echo 'font="Monospace,11,-1,5,50,0,0,0,0,0"' >> ~/.config/qt5ct/qt5ct.conf
echo 'icon_theme=Qogir' >> ~/.config/qt5ct/qt5ct.conf

# Kvantum theme configuration
mkdir -p ~/.config/Kvantum
tee ~/.config/Kvantum/kvantum.kvconfig > /dev/null <<EOF
[General]
theme=MateriaDark
EOF

echo 'export QT_STYLE_OVERRIDE=kvantum' >> ~/.xprofile

echo "Setup complete! River, Waybar, PulseAudio, NetworkManager, and other components are configured."
echo "You can select 'River' from the SDDM login screen to start your new setup."
